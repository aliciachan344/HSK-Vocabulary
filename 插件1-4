<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Â§©Â§©‰∏≠Êñá - Visual HSK V14 (Fixed)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', 'Noto Sans SC', sans-serif; background-color: #f8fafc; display: flex; flex-direction: column; min-height: 100vh; }
        
        .seal-wrapper { position: relative; width: 52px; height: 52px; background-color: #b91c1c; border-radius: 4px; padding: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid #fecaca; }
        .seal-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100%; height: 100%; gap: 1px; }
        .seal-char { font-family: 'Ma Shan Zheng', cursive; color: white; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center; }

        .perspective { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); background-color: white; overflow: hidden; }
        .card-back { transform: rotateY(180deg); }
        
        .hsk-btn-active { background-color: #b91c1c; color: white; border-color: #b91c1c; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(185, 28, 28, 0.2); }
        .hsk-btn-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .hsk-btn-inactive:hover { background-color: #fef2f2; border-color: #fecaca; color: #b91c1c; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .brand-text { background: linear-gradient(to right, #b91c1c, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>

<div id="app" class="flex-grow flex flex-col max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
    
    <!-- Error Handler UI -->
    <div v-if="hasError" class="fixed inset-0 bg-white z-50 flex items-center justify-center p-4 text-center">
        <div>
            <div class="text-4xl mb-2">‚ö†Ô∏è</div>
            <h2 class="text-xl font-bold text-red-600">Something went wrong</h2>
            <p class="text-gray-500 mt-2">Please refresh the page. If the issue persists, check the code syntax.</p>
        </div>
    </div>

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
        <div class="flex items-center gap-4">
            <div class="seal-wrapper"><div class="seal-grid"><div class="seal-char">Â§©</div><div class="seal-char">Â§©</div><div class="seal-char">‰∏≠</div><div class="seal-char">Êñá</div></div></div>
            <div><h1 class="text-2xl font-bold brand-text tracking-tight font-sans">Â§©Â§©‰∏≠Êñá</h1><p class="text-xs text-gray-400 font-medium tracking-widest uppercase">Visual HSK Learning</p></div>
        </div>
        <div class="flex bg-slate-100 p-1.5 rounded-xl">
            <button @click="currentView = 'study'" :class="currentView === 'study' ? 'bg-white text-red-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-5 py-2 rounded-lg text-sm font-bold transition-all">Study üìñ</button>
            <button @click="currentView = 'learned'" :class="currentView === 'learned' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-5 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2">Learned <span v-if="learnedCount > 0" class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full">{{ learnedCount }}</span></button>
        </div>
        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto items-center">
            <label class="flex items-center cursor-pointer select-none bg-red-50/50 px-3 py-2 rounded-lg border border-red-100 hover:bg-red-50 transition">
                <div class="relative"><input type="checkbox" v-model="isSlowMode" class="sr-only"><div class="w-9 h-5 bg-slate-300 rounded-full shadow-inner transition" :class="{ 'bg-red-500': isSlowMode }"></div><div class="absolute w-3.5 h-3.5 bg-white rounded-full shadow left-1 top-0.5 transition transform" :class="{ 'translate-x-4': isSlowMode }"></div></div>
                <div class="ml-2 text-xs font-bold text-red-700 flex items-center gap-1 uppercase tracking-wide"><i class="fa-solid fa-ear-listen"></i> Slow</div>
            </label>
            <div class="relative w-full md:w-60 group">
                <input v-model="searchQuery" type="text" placeholder="Search..." class="w-full pl-9 pr-8 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none text-sm transition group-hover:border-slate-300">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-2 top-2 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
    </header>

    <nav class="mb-6 overflow-x-auto pb-2 scrollbar-hide">
        <div class="flex gap-3 min-w-max justify-center md:justify-start">
            <button v-for="level in [1, 2, 3, 4]" :key="level" @click="switchLevel(level)" :class="currentLevel === level ? 'hsk-btn-active' : 'hsk-btn-inactive'" class="px-6 py-2 rounded-full text-sm font-bold border transition-all duration-200">HSK {{ level }}</button>
        </div>
    </nav>

    <main class="flex-grow">
        <div class="flex justify-between items-end mb-6 border-b border-slate-200 pb-2">
            <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                <span v-if="currentView === 'study'"><i class="fa-solid fa-list-ul text-red-500"></i> HSK {{ currentLevel }} List</span>
                <span v-else class="text-green-700"><i class="fa-solid fa-check-circle"></i> My Collection</span>
            </h2>
            <span class="text-xs text-slate-400 font-mono">Showing: {{ displayData.length }} words</span>
        </div>

        <div v-if="displayData.length > 0" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div v-for="item in paginatedData" :key="item.id" class="perspective h-[420px] group cursor-pointer select-none" @click="flipCard(item.id)">
                <div class="card-inner" :class="{ 'is-flipped': item.isFlipped }">
                    <div class="card-front flex flex-col border border-slate-100">
                        <div class="h-[55%] w-full relative bg-slate-100 overflow-hidden">
                            <img :src="getDisplayImage(item)" @error="handleImageError" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="Visual aid" loading="lazy">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-80"></div>
                            <div class="absolute top-3 left-3 flex gap-2"><span class="bg-red-600/90 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">HSK {{ item.level }}</span></div>
                            <button @click.stop="playAudio(item.hanzi)" class="absolute bottom-3 right-3 w-10 h-10 bg-white/90 hover:bg-white text-red-600 rounded-full shadow-lg transition flex items-center justify-center hover:scale-105 active:scale-95"><i class="fa-solid fa-volume-high text-lg"></i></button>
                        </div>
                        <div class="h-[45%] p-4 flex flex-col justify-between items-center text-center bg-white">
                            <div class="mt-2"><h3 class="text-3xl font-bold text-slate-800 mb-1">{{ item.hanzi }}</h3><p class="text-lg text-red-500 font-medium">{{ item.pinyin }}</p></div>
                            <div class="w-full border-t border-slate-100 pt-3"><span class="inline-block bg-slate-100 text-slate-500 text-xs px-1.5 py-0.5 rounded mr-1.5 align-middle mb-0.5">{{ item.pos }}</span><span class="text-sm text-slate-600 font-medium leading-snug align-middle line-clamp-2">{{ item.english }}</span></div>
                        </div>
                    </div>
                    <div class="card-back flex flex-col p-5 bg-white border-2 border-red-50">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-red-50">
                            <div><span class="text-2xl font-bold text-slate-800">{{ item.hanzi }}</span><span class="text-red-500 ml-2 text-sm font-medium">{{ item.pinyin }}</span></div>
                            <button @click.stop="playAudio(item.hanzi)" class="text-red-400 hover:text-red-600 w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center transition"><i class="fa-solid fa-volume-high"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto scrollbar-hide flex flex-col justify-center">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-2">Example Sentence</p>
                            <p class="text-lg text-slate-800 font-medium mb-1 leading-relaxed">{{ formatSentence(item) }}</p>
                            <p v-if="item.sentencePinyin" class="text-sm text-red-500/80 mb-2">{{ item.sentencePinyin }}</p>
                            <div class="relative pl-3 border-l-2 border-slate-200 py-1">
                                <p v-if="item.sentenceEn" class="text-xs text-slate-500 italic">"{{ item.sentenceEn }}"</p>
                                <p v-else class="text-xs text-slate-400 italic">Meaning: {{ item.english }}</p>
                            </div>
                            <button @click.stop="playAudio(formatSentence(item))" class="mt-4 w-full py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs text-slate-600 hover:text-red-600 hover:border-red-200 hover:bg-red-50 transition flex items-center justify-center gap-2"><i class="fa-solid fa-circle-play"></i> {{ isSlowMode ? 'Play Slow Audio' : 'Play Audio' }}</button>
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-100">
                            <button v-if="currentView === 'study'" @click.stop="toggleLearned(item.id)" class="w-full py-2.5 bg-green-500 text-white rounded-lg font-bold text-sm shadow hover:bg-green-600 hover:shadow-md transition-all active:scale-95 flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> Mark as Learned</button>
                            <button v-else @click.stop="toggleLearned(item.id)" class="w-full py-2.5 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg font-bold text-sm hover:bg-yellow-100 transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-left"></i> Review (Unlearn)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else class="flex flex-col items-center justify-center py-20 text-center">
            <div class="bg-slate-100 p-6 rounded-full mb-4"><i class="fa-solid fa-magnifying-glass text-4xl text-slate-300"></i></div>
            <h3 class="text-xl font-bold text-slate-700">No results found</h3>
            <button v-if="searchQuery" @click="searchQuery = ''" class="mt-4 text-red-600 font-bold hover:underline">Clear Search</button>
        </div>
    </main>

    <div v-if="currentView === 'study' && totalPages > 1" class="flex justify-center items-center mt-8 gap-4 pb-4">
        <button @click="prevPage" :disabled="currentPage === 1" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-red-50 hover:text-red-600 disabled:opacity-30 disabled:cursor-not-allowed shadow-sm transition"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="flex items-center gap-1 text-sm font-medium text-slate-500"><span class="text-slate-800 font-bold">{{ currentPage }}</span><span class="text-slate-300">/</span><span>{{ totalPages }}</span></div>
        <button @click="nextPage" :disabled="currentPage === totalPages" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-red-50 hover:text-red-600 disabled:opacity-30 disabled:cursor-not-allowed shadow-sm transition"><i class="fa-solid fa-chevron-right"></i></button>
    </div>

    <footer class="mt-auto border-t border-slate-200 bg-white py-8">
        <div class="flex flex-col items-center justify-center text-center gap-3">
            <a href="https://www.youtube.com/@TianTianChinese%E5%A4%A9%E5%A4%A9%E4%B8%AD%E6%96%87" target="_blank" class="group flex items-center gap-2 text-slate-600 hover:text-red-600 transition-colors">
                <i class="fa-brands fa-youtube text-2xl text-red-600 group-hover:scale-110 transition-transform"></i><span class="font-bold text-lg">Â§©Â§©‰∏≠Êñá TianTian Chinese</span>
            </a>
            <p class="text-xs text-slate-400">¬© 2025 TianTian Chinese. Visual HSK Learning.</p>
        </div>
    </footer>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const hasError = ref(false);
            const cards = ref([]);
            
            try {
                // ==========================================
                // Ê†∏ÂøÉÊï∞ÊçÆ (HSK 1-4 Á≤æÈÄâÁâà)
                // ==========================================
                const rawDb = [
                    // HSK 1 (Sample - 100% Fixed Images)
                    { id: 1, level: 1, hanzi: 'Áà±', pinyin: '√†i', pos: 'v.', english: 'to love', sentence: 'Â¶àÂ¶àÔºåÊàëÁà±‰Ω†„ÄÇ', sentenceEn: 'Mom, I love you.', fixedImg: 'https://images.unsplash.com/photo-1518199266791-5375a83190b7' },
                    { id: 4, level: 1, hanzi: 'ÊùØÂ≠ê', pinyin: 'bƒìizi', pos: 'n.', english: 'cup', sentence: 'ÊùØÂ≠êÈáåÊúâËå∂„ÄÇ', sentenceEn: 'There is tea in the cup.', fixedImg: 'https://images.unsplash.com/photo-1577937927133-66ef06acdf18' },
                    { id: 9, level: 1, hanzi: 'Ëèú', pinyin: 'c√†i', pos: 'n.', english: 'vegetable', sentence: 'ÊàëÂéªË∂ÖÂ∏Ç‰π∞ÁÇπÂÑøËèú„ÄÇ', sentenceEn: 'I go to buy some vegetables.', fixedImg: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd' },
                    { id: 12, level: 1, hanzi: 'Âá∫ÁßüËΩ¶', pinyin: 'ch≈´z≈´chƒì', pos: 'n.', english: 'taxi', sentence: 'Êàë‰ª¨ÂùêÂá∫ÁßüËΩ¶ÂéªÁÅ´ËΩ¶Á´ô„ÄÇ', sentenceEn: 'We take a taxi to the station.', fixedImg: 'https://images.unsplash.com/photo-1515549832467-b39153042cd7' },
                    { id: 61, level: 1, hanzi: '‰π∞', pinyin: 'm«éi', pos: 'v.', english: 'buy', sentence: 'Êàë‰π∞‰∫Ü‰∏Ä‰∫õËãπÊûú„ÄÇ', sentenceEn: 'I bought some apples.', fixedImg: 'https://images.unsplash.com/photo-1556742049-0cfed4f7a07d' }, 
                    { id: 62, level: 1, hanzi: 'Ê≤°ÂÖ≥Á≥ª', pinyin: 'm√©i guƒÅnxi', pos: 'phrase', english: 'It\'s okay', sentence: 'Áî≤ÔºöÂØπ‰∏çËµ∑ÔºÅ‰πôÔºöÊ≤°ÂÖ≥Á≥ª„ÄÇ', sentenceEn: 'A: Sorry! B: It\'s okay.', fixedImg: 'https://images.unsplash.com/photo-1582213782179-e0d53f98f2ca' },
                    { id: 63, level: 1, hanzi: 'Ê≤°Êúâ', pinyin: 'm√©iy«íu', pos: 'v.', english: 'not have', sentence: 'ÊàëÂÆ∂ÈáåÊ≤°Êúâ‰∫∫„ÄÇ', sentenceEn: 'There is no one at my home.', fixedImg: 'https://images.unsplash.com/photo-1499578124509-1611b77778c8' },
                    { id: 64, level: 1, hanzi: 'Á±≥È•≠', pinyin: 'm«êf√†n', pos: 'n.', english: 'rice', sentence: 'ÊàëÁà±ÂêÉÁ±≥È•≠„ÄÇ', sentenceEn: 'I love eating rice.', fixedImg: 'https://images.unsplash.com/photo-1516684732162-798a0062be99' },
                    
                    // HSK 2 (Sample)
                    { id: 154, level: 2, hanzi: 'Â∏ÆÂä©', pinyin: 'bƒÅngzh√π', pos: 'v.', english: 'help', sentence: 'ËØ∑Â∏ÆÂä©ÊàëÊâæ‰∏ÄÂÆ∂Êê¨ÂÆ∂ÂÖ¨Âè∏ÔºåÂ•ΩÂêóÔºü', sentenceEn: 'Please help me find a moving company.' },
                    { id: 159, level: 2, hanzi: 'Âî±Ê≠å', pinyin: 'ch√†nggƒì', pos: 'v.', english: 'sing', sentence: 'ÊàëÊúÄÁà±Âî±Ê≠å‰∫ÜÔºåÊàëÁªô‰Ω†‰ª¨Âî±‰∏Ä‰∏™„ÄÇ', sentenceEn: 'I love singing, let me sing one for you.' },
                    { id: 196, level: 2, hanzi: 'È∏°Ëõã', pinyin: 'jƒ´d√†n', pos: 'n.', english: 'egg', sentence: 'ÊàëÊØèÂ§©Êó©‰∏äÈÉΩË¶ÅÂêÉ‰∏™È∏°Ëõã„ÄÇ', sentenceEn: 'I eat an egg every morning.' },
                    
                    // HSK 3 (New - Auto Images)
                    { id: 301, level: 3, hanzi: 'ÈòøÂß®', pinyin: 'ƒÅy√≠', pos: 'n.', english: 'aunt', sentence: 'ÈòøÂß®ÔºåÈôÑËøëÊúâÂú∞ÈìÅÁ´ôÂêóÔºü', sentenceEn: 'Auntie, is there a subway station nearby?' },
                    { id: 302, level: 3, hanzi: 'Âïä', pinyin: 'a', pos: 'int.', english: 'ah', sentence: 'ÂïäÔºåËøôÂÑøÁöÑÁéØÂ¢ÉÂ§ö‰πàÂ•ΩÂïäÔºÅ', sentenceEn: 'Ah, the environment here is so good!' },
                    { id: 303, level: 3, hanzi: 'ÁüÆ', pinyin: '«éi', pos: 'adj.', english: 'short', sentence: 'ÂºüÂºüÁöÑ‰∏™Â≠êÊØîÊàëÁüÆ„ÄÇ', sentenceEn: 'My younger brother is shorter than me.' },
                    { id: 304, level: 3, hanzi: 'Áà±Â•Ω', pinyin: '√†ih√†o', pos: 'n.', english: 'hobby', sentence: 'ÊàëÊúÄÂ§ßÁöÑÁà±Â•ΩÂ∞±ÊòØÊâìÁØÆÁêÉ„ÄÇ', sentenceEn: 'My biggest hobby is playing basketball.' },
                    { id: 305, level: 3, hanzi: 'ÂÆâÈùô', pinyin: 'ƒÅnj√¨ng', pos: 'adj.', english: 'quiet', sentence: 'ÊïôÂÆ§ÈáåÂæàÂÆâÈùô„ÄÇ', sentenceEn: 'The classroom is very quiet.' },
                    
                    // HSK 4 (New - Auto Images)
                    { id: 601, level: 4, hanzi: 'Áà±ÊÉÖ', pinyin: '√†iq√≠ng', pos: 'n.', english: 'love; romance', sentence: 'ËøôÊòØ‰∏Ä‰∏™ÊÑü‰∫∫ÁöÑÁà±ÊÉÖÊïÖ‰∫ã„ÄÇ', sentenceEn: 'This is a touching love story.' },
                    { id: 602, level: 4, hanzi: 'ÂÆâÊéí', pinyin: 'ƒÅnp√°i', pos: 'v.', english: 'arrange', sentence: '‰∏ãÂçàÁöÑ‰ºöËÆÆÔºåÊàëÂ∑≤ÁªèÂÆâÊéíÂ•Ω‰∫Ü„ÄÇ', sentenceEn: 'I have arranged the meeting for this afternoon.' },
                    { id: 603, level: 4, hanzi: 'ÂÆâÂÖ®', pinyin: 'ƒÅnqu√°n', pos: 'adj.', english: 'safe', sentence: 'Êôö‰∏äÂºÄËΩ¶Ë¶ÅÊ≥®ÊÑèÂÆâÂÖ®„ÄÇ', sentenceEn: 'Pay attention to safety when driving at night.' },
                    { id: 604, level: 4, hanzi: 'ÊåâÊó∂', pinyin: '√†nsh√≠', pos: 'adv.', english: 'on time', sentence: 'ÊàëÊåâÊó∂ÂÆåÊàê‰∫Ü‰ªªÂä°„ÄÇ', sentenceEn: 'I completed the task on time.' }
                ].map(i => ({...i, isFlipped: false}));
                
                cards.value = rawDb;
            } catch (e) {
                hasError.value = true;
                console.error(e);
            }

            const currentLevel = ref(1);
            const currentView = ref('study'); 
            const searchQuery = ref('');
            const learnedIds = ref([]);
            const isSlowMode = ref(false); 
            const currentPage = ref(1);
            const pageSize = 8; 

            onMounted(() => {
                const saved = localStorage.getItem('hsk_learned_v14');
                if (saved) learnedIds.value = JSON.parse(saved);
            });

            watch(searchQuery, () => { currentPage.value = 1; });

            const getDisplayImage = (item) => {
                if (item.fixedImg) {
                    const cleanUrl = item.fixedImg.split('?')[0];
                    return `https://wsrv.nl/?url=${encodeURIComponent(cleanUrl)}&w=600&h=400&fit=cover&a=top`;
                } else {
                    return `https://image.pollinations.ai/prompt/photorealistic ${item.english}, minimalist style, high quality?nologo=true&seed=${item.id}&width=600&height=400`;
                }
            };

            const handleImageError = (e) => {
                e.target.src = 'https://via.placeholder.com/600x400/e2e8f0/94a3b8?text=Visual+HSK';
            };

            const formatSentence = (item) => {
                if (!item.sentence) return '';
                return item.sentence.replace(/ÔΩû|~/g, item.hanzi);
            };

            const displayData = computed(() => {
                let data = cards.value;
                data = data.filter(i => i.level === currentLevel.value);
                if (currentView.value === 'study') {
                    data = data.filter(i => !learnedIds.value.includes(i.id));
                } else {
                    data = data.filter(i => learnedIds.value.includes(i.id));
                }
                if (searchQuery.value) {
                    const q = searchQuery.value.trim().toLowerCase();
                    data = data.filter(i => 
                        i.hanzi.includes(q) || 
                        i.pinyin.toLowerCase().includes(q) || 
                        i.english.toLowerCase().includes(q)
                    );
                }
                return data;
            });

            const paginatedData = computed(() => {
                if (currentView.value === 'study' || displayData.value.length > pageSize) {
                    const start = (currentPage.value - 1) * pageSize;
                    return displayData.value.slice(start, start + pageSize);
                }
                return displayData.value;
            });

            const totalPages = computed(() => Math.ceil(displayData.value.length / pageSize));
            const learnedCount = computed(() => learnedIds.value.length);

            const switchLevel = (lvl) => {
                currentLevel.value = lvl;
                currentPage.value = 1; 
                searchQuery.value = '';
            };

            const flipCard = (id) => {
                const card = cards.value.find(c => c.id === id);
                if (card) {
                    if (!card.isFlipped) cards.value.forEach(c => { if(c.id !== id) c.isFlipped = false; });
                    card.isFlipped = !card.isFlipped;
                }
            };

            const toggleLearned = (id) => {
                const index = learnedIds.value.indexOf(id);
                if (index === -1) {
                    learnedIds.value.push(id);
                    if (paginatedData.value.length === 0 && currentPage.value > 1) currentPage.value--;
                } else {
                    learnedIds.value.splice(index, 1);
                }
                localStorage.setItem('hsk_learned_v14', JSON.stringify(learnedIds.value));
            };

            const playAudio = (text) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = isSlowMode.value ? 0.65 : 1; 
                    const voices = window.speechSynthesis.getVoices();
                    const bestVoice = voices.find(v => (v.lang === 'zh-CN' || v.lang === 'zh-TW') && v.name.includes('Google')) ||
                                      voices.find(v => v.lang === 'zh-CN');
                    if (bestVoice) utterance.voice = bestVoice;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const nextPage = () => { if (currentPage.value < totalPages.value) currentPage.value++; };
            const prevPage = () => { if (currentPage.value > 1) currentPage.value--; };

            return {
                currentLevel, currentView, isSlowMode, searchQuery, hasError,
                displayData, paginatedData, totalPages, currentPage, learnedCount,
                switchLevel, flipCard, playAudio, toggleLearned, nextPage, prevPage,
                handleImageError, getDisplayImage, formatSentence
            };
        }
    }).mount('#app');
</script>
</body>
</html>